/**
 * json_url         - url to fetch json object
 * cache            - use cache
 * height           - maximum number of element shown before scroll will apear
 * newel            - show typed text like a element
 * firstselected    - automaticly select first element from dropdown
 * filter_case      - case sensitive filter
 * filter_selected  - filter selected items from list
 * complete_text    - text for complete page
 * maxshownitems    - maximum numbers that will be shown at dropdown list (less better performance)
 * onselect         - fire event on item select
 * onremove         - fire event on item remove
 * maxitimes        - maximum items that can be added
 * delay            - delay between ajax request (bigger delay, lower server time request)
 * addontab         - add first visible element on tab or enter hit
 * attachto         - after this element fcbkcomplete insert own elements
 * multiple         - whether the list gives multiple elements or not
 * params           - to pass the parameters, the parameter 'q' is passed by default as query parameter.
 * beforesend		- fire event to change various parameters before sending the AJAX request
 */ 
jQuery(function($){$.fn.fcbkcomplete=function(x){return this.each(function(){function init(){createFCBK();preSet();addInput(0)}function createFCBK(){v.hide();if(k.multiple){v.attr("multiple","multiple");if(v.attr("name").indexOf("[]")==-1){v.attr("name",v.attr("name")+"[]")}}else{k.maxitems=1}l=$(document.createElement("ul"));l.attr("class","holder");if(k.attachto){if(typeof(k.attachto)=="object"){k.attachto.append(l)}else{$(k.attachto).append(l)}}else{v.after(l)}n=$(document.createElement("div"));n.addClass("facebook-auto");n.append('<div class="default">'+k.complete_text+"</div>");n.hover(function(){k.complete_hover=0},function(){k.complete_hover=1});m=$(document.createElement("ul"));m.attr("id",w+"_feed");n.prepend(m);l.after(n);m.css("width",n.width())}function preSet(){v.children("option").each(function(i,a){a=$(a);if(a.hasClass("selected")){addItem(a.text(),a.val(),true,a.hasClass("locked"));a.attr("selected","selected")}p.push({key:a.text(),value:a.val()});r+=""+(p.length-1)+":"+a.text()+";"})}$(this).bind("addItem",function(a,b){addItem(b.title,b.value,0,0,0)});$(this).bind("removeItem",function(a,b){var c=l.children('li[rel='+b.value+']');if(c.length){removeItem(c)}});$(this).bind("destroy",function(a,b){l.remove();n.remove();v.show()});function addItem(a,b,c,d,e){if(!maxItems()){return false}var f=document.createElement("li");var g=document.createTextNode(a);var h=document.createElement("a");var i="bit-box"+(d?" locked":"");$(f).attr({"class":i,"rel":b});$(f).prepend(g);$(h).attr({"class":"closebutton","href":"#"});f.appendChild(h);l.append(f);$(h).click(function(){removeItem($(this).parent("li"));return false});if(!c){$("#"+w+"_annoninput").remove();var j;addInput(e);if(v.children("option[value="+b+"]").length){j=v.children("option[value="+b+"]");j.get(0).setAttribute("selected","selected");j.attr("selected","selected");if(!j.hasClass("selected")){j.addClass("selected")}}else{var j=$(document.createElement("option"));j.attr("value",b).get(0).setAttribute("selected","selected");j.attr("value",b).attr("selected","selected");j.attr("value",b).addClass("selected");j.text(a);v.append(j)}if(k.onselect){funCall(k.onselect,j)}v.change()}l.children("li.bit-box.deleted").removeClass("deleted");m.hide()}function removeItem(a){if(!a.hasClass('locked')){a.fadeOut("fast");if(k.onremove){var b=v.children("option[value="+a.attr("rel")+"]");funCall(k.onremove,b)}v.children('option[value="'+a.attr("rel")+'"]').removeAttr("selected").removeClass("selected");a.remove();v.change();t=0}}function addInput(f){var g=$(document.createElement("li"));var h=$(document.createElement("input"));var i=0;g.attr({"class":"bit-input","id":w+"_annoninput"});h.attr({"type":"text","class":"maininput","size":"1"});l.append(g.append(h));h.focus(function(){n.fadeIn("fast")});h.blur(function(){if(k.complete_hover){n.fadeOut("fast")}else{h.focus()}});l.click(function(){h.focus();if(m.length&&h.val().length){m.show()}else{m.hide();n.children(".default").show()}});h.keypress(function(a){if(a.keyCode==13){return false}h.attr("size",h.val().length+1)});h.keydown(function(a){if(a.keyCode==191){a.preventDefault();return false}});h.keyup(function(c){var d=xssPrevent(h.val());if(c.keyCode==8&&d.length==0){m.hide();if(!l.children("li.bit-box:last").hasClass('locked')){if(l.children("li.bit-box.deleted").length==0){l.children("li.bit-box:last").addClass("deleted");return false}else{if(t){return}t=1;l.children("li.bit-box.deleted").fadeOut("fast",function(){removeItem($(this));return false})}}}if(c.keyCode!=40&&c.keyCode!=38&&c.keyCode!=37&&c.keyCode!=39&&d.length!=0){o=0;if(k.json_url){if(k.cache&&q){addMembers(d);bindEvents()}else{i++;var e=i;setTimeout(function(){if(e!=i)return;var b=k.json_url;k.params['q']=d;$.ajax({url:k.json_url,data:k.params,type:"POST",dataType:"json",success:function(a){addMembers(d,a);q=true;bindEvents()}})},k.delay)}}else{addMembers(d);bindEvents()}n.children(".default").hide();m.show()}});if(f){setTimeout(function(){h.focus();n.children(".default").show()},1)}}function addMembers(b,c){m.html('');if(!k.cache&&c!=null){p=new Array();r=""}addTextItem(b);if(c!=null&&c.length){$.each(c,function(i,a){p.push({key:a.key,value:a.value});r+=""+(p.length-1)+":"+a.key+";"})}var d=k.maxshownitems<p.length?k.maxshownitems:p.length;var e="i";if(k.filter_case){e=""}var f,match;try{f=eval('/(?:^|;)\\s*(\\d+)\\s*:[^;]*?'+b+'[^;]*/g'+e);match=f.exec(r)}catch(ex){};var g='';while(match!=null&&d>0){var h=match[1];var j=p[h];if(k.filter_selected&&v.children("option[value="+j.value+"]").hasClass("selected")){}else{g+='<li rel="'+j.value+'">'+itemIllumination(j.key,b)+'</li>';o++;d--}match=f.exec(r)}m.append(g);if(k.firstselected){s=m.children("li:visible:first");s.addClass("auto-focus")}if(o>k.height){m.css({"height":(k.height*24)+"px","overflow":"auto"})}else{m.css("height","auto")}}function itemIllumination(a,b){if(k.filter_case){try{eval("var text = text.replace(/(.*)("+b+")(.*)/gi,'$1<em>$2</em>$3');")}catch(ex){}}else{try{eval("var text = text.replace(/(.*)("+b.toLowerCase()+")(.*)/gi,'$1<em>$2</em>$3');")}catch(ex){}}return a}function bindFeedEvent(){m.children("li").mouseover(function(){m.children("li").removeClass("auto-focus");$(this).addClass("auto-focus");s=$(this)});m.children("li").mouseout(function(){$(this).removeClass("auto-focus");s=null})}function removeFeedEvent(){m.children("li").unbind("mouseover");m.children("li").unbind("mouseout");m.mousemove(function(){bindFeedEvent();m.unbind("mousemove")})}function bindEvents(){var f=$("#"+w+"_annoninput").children(".maininput");bindFeedEvent();m.children("li").unbind("mousedown");m.children("li").mousedown(function(){var a=$(this);addItem(a.text(),a.attr("rel"),0,0,1);m.hide();n.hide()});f.unbind("keydown");f.keydown(function(a){if(a.keyCode==191){a.preventDefault();return false}if(a.keyCode!=8){l.children("li.bit-box.deleted").removeClass("deleted")}if((a.keyCode==13||a.keyCode==9)&&checkFocusOn()){var b=s;addItem(b.text(),b.attr("rel"),0,0,1);n.hide();a.preventDefault();s=null;return false}if((a.keyCode==13||a.keyCode==9)&&!checkFocusOn()){if(k.newel){var c=xssPrevent($(this).val());addItem(c,c,0,0,1);n.hide();a.preventDefault();s=null;return false}if(k.addontab){s=m.children("li:visible:first");var b=s;addItem(b.text(),b.attr("rel"),0,0,1);n.hide();a.preventDefault();s=null;return false}}if(a.keyCode==40){removeFeedEvent();if(s==null||s.length==0){s=m.children("li:visible:first");m.get(0).scrollTop=0}else{s.removeClass("auto-focus");s=s.nextAll("li:visible:first");var d=parseInt(s.prevAll("li:visible").length,10);var e=parseInt(s.nextAll("li:visible").length,10);if((d>Math.round(k.height/2)||e<=Math.round(k.height/2))&&typeof(s.get(0))!="undefined"){m.get(0).scrollTop=parseInt(s.get(0).scrollHeight,10)*(d-Math.round(k.height/2))}}m.children("li").removeClass("auto-focus");s.addClass("auto-focus")}if(a.keyCode==38){removeFeedEvent();if(s==null||s.length==0){s=m.children("li:visible:last");m.get(0).scrollTop=parseInt(s.get(0).scrollHeight,10)*(parseInt(m.children("li:visible").length,10)-Math.round(k.height/2))}else{s.removeClass("auto-focus");s=s.prevAll("li:visible:first");var d=parseInt(s.prevAll("li:visible").length,10);var e=parseInt(s.nextAll("li:visible").length,10);if((e>Math.round(k.height/2)||d<=Math.round(k.height/2))&&typeof(s.get(0))!="undefined"){m.get(0).scrollTop=parseInt(s.get(0).scrollHeight,10)*(d-Math.round(k.height/2))}}m.children("li").removeClass("auto-focus");s.addClass("auto-focus")}})}function maxItems(){if(k.maxitems!=0){if(l.children("li.bit-box").length<k.maxitems){return true}else{return false}}}function addTextItem(a){if(k.newel&&maxItems()){m.children("li[fckb=1]").remove();if(a.length==0){return}var b=$(document.createElement("li"));b.attr({"rel":a,"fckb":"1"}).html(a);m.prepend(b);o++}else{return}}function funCall(a,b){var c="";for(i=0;i<b.get(0).attributes.length;i++){if(b.get(0).attributes[i].nodeValue!=null){c+="\"_"+b.get(0).attributes[i].nodeName+"\": \""+b.get(0).attributes[i].nodeValue+"\","}}c="{"+c+" notinuse: 0}";a.call(a,c)}function checkFocusOn(){if(s==null){return false}if(s.length==0){return false}return true}function xssPrevent(a){a=a.replace(/[\"\'][\s]*javascript:(.*)[\"\']/g,"\"\"");a=a.replace(/script(.*)/g,"");a=a.replace(/eval\((.*)\)/g,"");a=a.replace('/([\x00-\x08,\x0b-\x0c,\x0e-\x19])/','');return a}var k=$.extend({json_url:null,cache:false,height:"10",newel:false,addontab:false,firstselected:false,filter_case:false,filter_selected:false,complete_text:"Start to type...",maxshownitems:30,maxitems:10,onselect:null,onremove:null,attachto:null,delay:350,multiple:true,params:{}},x);var l=null;var m=null;var n=null;var o=0;var p=new Array();var q=false;var r="";var s=null;var t=0;var u=1;var v=$(this);var w=v.attr("id");init();return this})}});